# No.004-1: 具体的なテストケース

本ドキュメントは、[No.004: テスト計画](./004-test-plan.md)に基づき、単体・結合・総合の各テストフェーズで実施する具体的なテストケースを定義します。

## 1. 単体テスト (Unit Tests)

個々の関数や計算ロジックが独立して正しく動作することを確認します。

| テストID | テスト対象 | テスト内容 | 前提条件・入力 | 期待される結果 | ステータス |
| :--- | :--- | :--- | :--- | :--- | :--- |
| **UT-001** | `computeNetAnnual` (`financial.ts`) | **正常系:** 一般的な年収での手取り額計算 | 額面年収: 5,000,000円 | 計算ロジックに基づいた正確な手取り額が返却される（例: 約390万円）。 | ✅ 合格 |
| **UT-002** | `computeNetAnnual` (`financial.ts`) | **境界値:** 収入が0の場合 | 額面年収: 0円 | 手取り額が0円として返却される。 | ✅ 合格 |
| **UT-003** | `computeNetAnnual` (`financial.ts`) | **境界値:** 所得税率が変わる境界の年収 | 額面年収: 6,950,000円 | 正しい所得税率区分で計算された手取り額が返却される。 | ✅ 合格 |
| **UT-004** | `calculateRetirementIncomeTax` (`financial.ts`) | **正常系:** 退職所得控除と税額の計算 | 退職所得: 20,000,000円<br>勤続年数: 30年 | 勤続年数に応じた控除額（1500万円）が適用され、課税対象額（(2000-1500)/2=250万円）に対する正しい税額が計算される。 | ✅ 合格 |
| **UT-005** | `calculateRetirementIncomeTax` (`financial.ts`) | **境界値:** 控除額が所得を上回る場合 | 退職所得: 8,000,000円<br>勤続年数: 25年 | 控除額（1150万円）が所得を上回るため、税額が0円になる。 | ✅ 合格 |
| **UT-006** | `getAnnualChildCost` (`api/simulate/index.ts`) | **正常系:** 子供の年齢に応じた教育費計算 | 年齢: 16歳<br>パターン: '私立中心' | `EDUCATION_COST_TABLE`に基づき、高校生の私立の年間費用が返却される。 | ✅ 合格 |
| **UT-007** | `withdrawToCoverShortfall` (`api/simulate/index.ts`) | **正常系:** 資産取り崩し順序（課税→NISA） | 不足額: 300万円<br>課税口座: 200万円<br>NISA口座: 500万円 | 1. 課税口座から200万円取り崩し。<br>2. 残り不足額100万円をNISA口座から取り崩し。<br>3. NISAの売却元本分が翌年の復活枠(`nisaRecycleAmount`)に加算される。 | ✅ 合格 |
| **UT-008** | `generateReturnSeries` (`api/simulate/index.ts`) | **正常系:** リターン系列の生成 | 平均リターン: 5%<br>ボラティリティ: 15%<br>年数: 30年 | 1. 長さ30の配列が返る。<br>2. 配列の算術平均が5%に収束する。<br>3. 暴落イベントがランダムに注入されている。 | ✅ 合格 |
| **UT-009** | 状態管理ストア (`useFormState.ts`) | **状態クリーンアップロジック検証** | 1. ストアのアクションを使い「子供あり」の状態（人数:2人）をセット。<br>2. 次に「子供なし」に変更するアクションを実行。 | ストアのstateから `numberOfChildren` や `educationPattern` などの子供関連プロパティが削除、または初期値にリセットされている。 | ✅ 合格 |
| **UT-010** | UIコンポーネント (`ChildrenSection.tsx`) | **UI操作と状態変更の連携検証** | 1. コンポーネントをレンダリング。<br>2. 「はい」ラジオボタンをクリック。<br>3. 「いいえ」ラジオボタンをクリック。 | 状態をリセットするためのアクション（例: `resetChildrenData`）が呼び出されたことをモックで確認する。 | 🚧 未着手 |

## 2. 結合テスト (Integration Tests)

複数のモジュールを連携させ、データフローや相互作用が正しく機能することを確認します。

| テストID | テスト対象 | テスト内容 | 前提条件・入力 | 期待される結果 | ステータス |
| :--- | :--- | :--- | :--- | :--- | :--- |
| **IT-001** | フォーム入力 → APIパラメータ変換 (`api-adapter.ts`) | **正常系:** フォームの全項目入力 | `FormPage`で全ての必須項目とライフイベント（車、住宅、子供など）を入力。 | `createApiParams`関数により、全ての入力が円単位の数値や適切なオブジェクト構造に変換された`SimulationInputParams`が生成される。 | ✅ 合格 |
| **IT-002** | APIパラメータ変換 → シミュレーション実行 (`api/simulate/index.ts`) | **正常系:** 定年再雇用シナリオ | `assumeReemployment: true`, `reemploymentReductionRate: "30"` を含むAPIパラメータを渡す。 | 1. 60歳から退職年齢まで、収入が指定の減給率で減少する。<br>2. 60歳以降は昇給が停止する。<br>3. `yearlyData`の`incomeDetail`に反映される。 | ✅ 合格 |
| **IT-003** | APIパラメータ変換 → シミュレーション実行 (`api/simulate/index.ts`) | **正常系:** NISA夫婦利用シナリオ | `useSpouseNisa: true` を含むAPIパラメータを渡す。 | NISAの生涯非課税枠の上限が`FC.NISA_LIFETIME_CAP * FC.NISA_COUPLE_MULTIPLIER`（3600万円）で計算される。 | ✅ 合格 |
| **IT-004** | シミュレーションコアロジック | **複数年:** 資産の年次引き継ぎ | 1年目のシミュレーションを実行し、年末の`totalAssets`が1000万円だったとする。 | 2年目のシミュレーション開始時の資産額が、1年目の年末資産額（1000万円）を正しく引き継いでいる。 | ✅ 合格 |
| **IT-005** | シミュレーションコアロジック | **条件分岐:** 生活防衛資金の補填ロジック | 年間収支が赤字になり、`savings`が`emergencyFundJPY`を下回るシナリオ。 | 1. `debug.replenishmentTriggered`が`true`になる。<br>2. 投資口座（課税→NISAの順）が取り崩され、`savings`が`emergencyFundJPY`まで回復する。<br>3. `yearlyData`の各資産残高が正しく更新される。 | ✅ 合格 |
| **IT-006** | シミュレーションコアロジック | **複数年:** NISA売却枠の翌年復活 | 1. ある年にNISA口座を売却（取り崩し）する。<br>2. `nisaRecycleAmountForNextYear`に売却元本額が記録される。 | 翌年のNISA投資可能枠（`cumulativeNisaContribution`の計算）が、売却した元本分だけ回復している。 | ✅ 合格 |
| **IT-007** | APIエンドポイント (`/api/simulate`) | **異常系:** 不正な入力 | `initialAge`をマイナス値にするなど、不正な`inputParams`でAPIをPOSTする。 | APIがステータスコード400 (Bad Request) とエラーメッセージを返す。 | ✅ 合格 |
| **IT-008** | フォーム状態管理 → APIパラメータ変換 | **条件分岐項目の状態クリーンアップ検証** | 1. 「子供あり」で関連項目（人数など）を入力。<br>2. 「戻る」ボタンで前のセクションに戻る。<br>3. 「子供なし」に選択を変更し、最後まで進む。 | APIに送信されるパラメータから、子供関連のプロパティ（`numberOfChildren`など）が削除されている、または`hasChildren: false`が正しく設定されている。 | 🚧 未着手 |
| **IT-009** | フォーム状態管理 → APIパラメータ変換 | **確認画面からの修正反映検証** | 1. 全項目を入力し、確認画面へ遷移。<br>2. 確認画面の「修正」ボタンで収入セクションに戻る。<br>3. 年収額を変更し、再度確認画面へ進む。 | 1. APIに送信されるパラメータの年収が、変更後の値に正しく更新されている。<br>2. 他のセクションの入力値は変更前と同一である。 | 🚧 未着手 |
| **IT-010** | フォーム状態管理 → APIパラメータ変換 | **条件分岐項目の状態クリーンアップ検証（再雇用）** | 1. 「定年再雇用を想定する」で減給率を入力。<br>2. 「戻る」ボタンで前のセクションに戻る。<br>3. 「想定しない」に選択を変更し、最後まで進む。 | APIに送信されるパラメータから、再雇用関連のプロパティ（`reemployment`など）が削除されていることを確認する。 | 🚧 未着手 |

## 3. 総合テスト (System/Comprehensive Tests)

実際のユーザー利用を想定したシナリオに基づき、システム全体が要件を満たしているかを確認します。

| テストID | テスト対象 | テストシナリオ | 主要な入力条件 | 期待される結果 |
| :--- | :--- | :--- | :--- | :--- |
| **ST-001** | エンドツーエンド | **標準ファミリーケース** | ・30代夫婦、子供1人<br>・世帯年収800万円<br>・住宅ローン返済中<br>・毎月NISAとiDeCoに積立投資 | ・退職年齢（65歳）まで順調に資産が増加する。<br>・老後は資産を取り崩しながら生活し、シミュレーション終了（95歳）まで資産が枯渇しない。<br>・結果グラフ（総資産、資産配分）が直感的に理解できる形で表示される。 |
| **ST-002** | エンドツーエンド | **独身・高収入・積極投資ケース** | ・20代独身<br>・年収1000万円<br>・投資比率が高く、リスク許容度も高い（ランダム変動シナリオ） | ・資産が急角度で増加し、早期リタイア（55歳など）が可能な資産水準に到達する。<br>・モンテカルロシミュレーションを実行した場合、プラン破綻確率が非常に低く表示される。 |
| **ST-003** | エンドツーエンド | **ライフイベント集中ケース** | ・30歳で結婚、32歳で住宅購入、33歳で第一子誕生、35歳で車買い替え。<br>・各イベントで大きな支出が発生。 | ・30代で一時的に資産の伸びが停滞、または減少する。<br>・40代以降、支出が落ち着き再び資産が増加に転じる。<br>・結果ページのタイムラインに各イベントが正しい年齢で表示される。 |
| **ST-004** | エンドツーエンド | **老後破綻リスクケース** | ・40代夫婦、子供2人（私立）<br>・世帯年収600万円<br>・貯蓄・投資額が少ない | ・子供の教育費がかさむ期間に資産が伸び悩む。<br>・老後、年金だけでは生活費を賄えず、早い段階で資産が枯渇する（例: 80歳で破綻）。<br>・総資産グラフが0を下回る。 |
| **ST-005** | パフォーマンス | **長期シミュレーション** | ・シミュレーション期間を最長に設定（例: 25歳〜100歳）。<br>・モンテカルロシミュレーション（100回）を実行。 | ・シミュレーション実行ボタン押下後、許容可能な時間内（例: 10秒以内）に結果が表示される。 |
| **ST-006** | UI/UX | **レスポンシブ表示** | PC、タブレット、スマートフォンの各デバイス（またはブラウザのデベロッパーツール）で結果ページを表示する。 | ・レイアウト崩れがなく、グラフや表が画面サイズに応じて適切にリサイズ・調整される。<br>・操作性（スクロール、タップ）に問題がない。 |