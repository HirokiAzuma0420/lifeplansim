目的・原則
- 主語は投資「商品」。年次シミュレーションも可視化も商品別を基準にする。
- 口座（課税/NISA/iDeCo）は税制・拠出上限・引き出し可否・売却時課税の判定専用とし、可視化の主軸にはしない（必要に応じて切替表示は可）。

入力仕様（FormPage → API）
- 年齢・期間
  - `initialAge`（開始年齢）、`retirementAge`（退職年齢）、`endAge`（シミュレーション最終年齢）
- 収入（万円/年を入力しAPIで円に変換）
  - 本人・配偶者の本業/副業、昇給率（%/年→APIで0–1に変換）
- 支出
  - 簡易モード: 生活費（円/月×12）
  - 詳細モード: 固定/変動（円/月×12）＋住居/車/結婚/子ども/介護/家電などのイベント
- 貯蓄・予備資金
  - `currentSavingsJPY`（万円→円）、`monthlySavingsJPY`（円/月）、`emergencyFundJPY`（万円→円）
- 投資（商品配列が一次情報）
  - `products: { key, account: 'taxable'|'nisa'|'ideco', currentJPY, recurringJPY, spotJPY, expectedReturn }[]`
  - 単位は API 受け取り時点ですべて円。金利は百分率（1.5 など）

投資ロジック（確定）
- 評価益に対する年次課税は行わない（売却時のみ課税）
- NISA 拠出
  - 生涯上限 1,800 万円。到達時点で以後の NISA 拠出は停止（課税へスピルしない）
  - 年間上限の配分順序は「つみたて → スポット → 入力順」で割当
  - 初期保有が生涯枠超の場合も以降の拠出は常に 0（保有は維持）
- iDeCo（退職年齢基準、非課税）
  - 退職年齢がシミュレーション期間内: その年に一括現金化し `savings` へ振替、`ideco=0`
  - 退職年齢 ≤ 開始年齢: 初年度に一括現金化
  - 退職年齢 > 最終年齢（endAge）: 初年度に一括現金化
  - それまでは取り崩し不可（緊急予備資金の原資に含めない）
- 課税口座の売却
  - 売却時のみ 20.315% を控除（ネット入金 = 売却額 × (1 − 税率)）
- 緊急予備資金の取り崩し
  - `savings < emergencyFundJPY` の場合、課税 → NISA の順に売却して充当（iDeCo は対象外）
- リターンのノイズ
  - 現行のストレスシナリオ（乱数・種）を継続使用。将来的にはモンテカルロ法に拡張予定

年次フロー（高レベル）
- 収入: 本人/配偶者の総収入 → `computeNetAnnual` で手取り化
- 支出: 生活費（簡易/詳細）＋住居/車/教育/介護/結婚/家電/退職後費用の合算
- 投資更新: 商品×口座で 残高 = 残高×(1+リターン) + 当年拠出（NISA 上限適用）
- 緊急予備資金: 不足時は課税→NISA の順に売却（売却税制を適用）
- iDeCo 現金化: ルールに従って該当年に `savings` へ振替
- 総資産: `savings + Σ(全商品の[課税+NISA+iDeCo]残高)`

API 出力仕様（YearlyData の拡張方針）
- 既存フィールドを維持
  - `income, totalExpense, savings, nisa, ideco, totalAssets, investedPrincipal, assetAllocation`
- 追加（商品主語の可視化用）
  - `productTotals: Record<string, number>` … 商品別の合算残高（全口座合算）
  - `productAccounts: Record<string, { taxable: number; nisa: number; ideco: number }>`
- 後方互換
  - 既存の `products`（課税のみの明細）は当面維持（段階的廃止を視野）

可視化仕様（ResultPage＋コンポーネント）
- すべての商品を表示すること（現金/NISA/iDeCo のみで終わらせない）
- 追加/変更
  - 最新年「商品別テーブル」: `productTotals` を表示（課税限定テーブルを置換）
  - 商品別の時系列チャート（全口座合算の折れ線/積上げ）
  - 円グラフ: 商品別の比率（最新年）。必要に応じて口座別との切替を提供
  - 年次表: 年・現金・総資産に加え、商品別の列も表示（列数が多い場合は横スクロール）
- 維持
  - 既存の現金/NISA/iDeCo の集計チャートは切替表示として維持可能
- 表示単位
  - 基本のグラフは「万円」単位で表示（軸・ツールチップともに万円表記）。テーブルは円/万円のいずれかで整合

丸め・バリデーション
- 入力負値は 0 へクリップ。年次出力は `Math.round` を基本とし、表示は桁区切り
- 単位変換の一貫性（Form の万円→API の円、金利の百分率→内部小数）

受け入れ基準（サンプル）
- NISA の生涯拠出が 1,800 万円を超えない（当年クリップ・以後停止）
- 退職年齢ルールに従い iDeCo が適切な年に 0 となり、`savings` へ等額が加算される
- `totalAssets = savings + Σ(productAccounts[*].taxable + nisa + ideco)` が成立する（丸め誤差以内）
- 最新年テーブルの商品値と商品別時系列の最終年が一致
- 円グラフ・スタックチャート・年次表に全商品の情報が反映される

既知の別件（実装時に是正）
- 住宅ローン金利の単位ずれ（Form は小数、API は百分率）
- 住宅ローン返済の二重計上（`currentLoan` 加算が二箇所）
- 課税 `productBalances` の `totalAssets/assetAllocation` 未反映
- NISA 初期残高の二重計上可能性（`investmentTaxation` と `products` の重複）
- フォームの手取りプレビューで控除を二重計算（表示のみ）

将来拡張
- リターン生成のモンテカルロ法対応
- 商品×口座のスタック表示や、商品グルーピング（国内株/外株/債券/BTC 等）
- 取り崩しの按分ルール（商品別の売却配分の明確化）

