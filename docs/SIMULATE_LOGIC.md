# シミュレーションロジック解説

このドキュメントは、ライフプランシミュレーションのコアロジックについて体系的に解説します。シミュレーションは `api/simulate/index.ts` 内の `runSimulation` 関数で実行されます。

## 1. 初期設定

シミュレーションを開始する前に、以下の初期設定が行われます。

- **入力パラメータの展開**: ユーザーが入力した家族情報、収入、支出、資産状況などのパラメータを読み込みます。
- **資産の初期化**:
    -   `savings`: `currentSavingsJPY` を初期値として設定。
    -   `productBalances`: 各投資商品の元本（`principal`）と評価額（`balance`）を `currentJPY` を基に初期化。
- **NISA生涯投資枠の初期化**:
    -   `cumulativeNisaContribution`: NISA口座（非課税）に設定された初期資産（`currentJPY`）の合計額を、生涯投資枠の利用済み分として初期化します。
    -   `nisaRecycleAmountForNextYear`: NISAの売却枠復活を管理する変数。0で初期化されます。
- **リターン系列の生成**:
    -   `interestScenario` が `'ランダム変動'` の場合、各投資商品に対して、期待リターンとボラティリティに基づいた年次リターンの時系列データを事前に生成します。

## 2. 年次シミュレーションループ

初期設定後、`initialAge` から `endAge` まで、1年単位でループ処理を実行します。各年の処理は以下の順序で行われます。

### ステップ 0: NISA投資枠の復活

ループの最初に、前年にNISA資産を売却した分の投資枠を復活させます。

-   `cumulativeNisaContribution`（NISA生涯投資枠の累計利用額）から `nisaRecycleAmountForNextYear`（前年売却分の元本額）を減算します。
-   `nisaRecycleAmountForNextYear` を0にリセットし、その年の売却額を記録する準備をします。

### ステップ 1: イベント処理

特定の年齢で発生するライフイベントを処理します。

-   **iDeCo現金化**: `retirementAge`（ただし75歳上限）に達した場合、iDeCoの全資産を売却し、現金（`savings`）に加算します。
-   **結婚**: 設定された年齢で結婚イベントが発生。配偶者の情報（年齢、収入）や、新しい生活費・住居費がシミュレーションに反映されます。

### ステップ 2: 収入計算

その年の手取り収入を計算します。

-   本人と配偶者の給与収入（昇給率を考慮）と副業収入を合算。
-   iDeCoの掛金は所得控除として総所得から差し引かれます。
-   上記から、社会保険料、所得税、住民税を差し引いた手取り年収を算出します。
-   年金受給開始年齢に達している場合は、年金収入も加算します。

### ステップ 3: 支出計算

その年に発生する全ての支出項目を合算します。

-   **生活費**: 退職前は設定された生活費、退職後は退職後生活費を計上。
-   **住居費**: 家賃、住宅ローン返済、家の購入（頭金＋ローン）、リフォーム費用。
-   **車両費**: 車の購入（現金/ローン）、ローン返済。
-   **教育費**: 子供の年齢と教育プラン（公立/私立など）に応じた費用。
-   **その他**: 家電購入、親の介護費用、結婚費用など、設定されたイベントに基づき計上。

### ステップ 4: キャッシュフローと現金残高の更新

-   `cashFlow = 年間収入 - 年間総支出` を計算。
-   `savings`（現金残高）に `cashFlow` を加算します。

### ステップ 5: 資産の取り崩し（赤字補填）

現金残高が `emergencyFundJPY`（生活防衛資金）を下回った場合に、不足分を補うために投資資産を売却します。

1.  **売却順序**: ①課税口座 → ②非課税口座（NISA）の順で売却します。
2.  **売却額**: 生活防衛資金を回復させるのに必要な金額を売却します。
3.  **税金**: 課税口座の売却で利益が出ている場合、利益に対して`20.315%`の税金が差し引かれ、手取り額が現金に加算されます。
4.  **NISA枠の復活準備**: 非課税口座（NISA）の資産を売却した場合、その**元本相当額**が `nisaRecycleAmountForNextYear` に記録されます。この金額が、翌年のループ開始時に投資枠として復活します。

### ステップ 6: 投資の実行（黒字の場合）

退職年齢に達するまで、かつ現金残高に余裕がある場合に、計画された投資を実行します。

1.  **投資可能額の決定**: `investableAmount = savings - emergencyFundJPY` として、投資に回せる上限額を決定します。
2.  **投資の実行**: `productList` に設定された順序で、各商品の投資を実行します。
    -   **iDeCo / 課税口座**: 計画された投資額（積立＋スポット）と投資可能額の小さい方を投資します。
    -   **非課税口座（NISA）**: 以下の3つのうち、**最も小さい金額**がその年のNISAへの投資額となります。
        1.  計画された投資額（積立＋スポット）
        2.  `remainingNisaAllowance`: 生涯投資枠の残り（1800万円 - 累計利用額）
        3.  `remainingAnnualCap`: その年の年間投資枠の残り（**360万円** - その年にNISAに投資済みの額）

### ステップ 7: 資産の成長

全ての投資商品（`productBalances`）の評価額（`balance`）に対して、その年のリターン（固定またはランダム）を反映させ、資産を成長させます。

### ステップ 8: 年間データの集計

その年のシミュレーション結果（収入、支出、資産、負債など）を `yearlyData` 配列に記録し、次の年のループに進みます。