# 実装計画書（Implementation Plan）- ライフプラン・シミュレーター

本計画は現行コードベースを踏まえ、MVP完成→品質向上→拡張の順で実装を段階化します。各項目は対象ファイル、実装方針、完了条件を明確化します。

## 1. 基本方針
- 最小価値（MVP）を最短で一気通貫化：フォーム入力 → API実行 → 結果可視化。
- 既存資産の最大活用：`api/simulate/index.ts`、`components/dashboard/*` を結果画面に統合。
- 型とバリデーションを前倒しで整備し、以降の改修コストを削減。

## 2. フェーズ別ロードマップ

### Phase 0: 一気通貫の成立（MVP）
1) 結果ページの実装とルーティング整備
   - 追加: `src/pages/ResultPage.tsx`（年次データを受け取り、ダッシュボード表示を統合）
   - 変更: `src/App.tsx` に `/result` ルートを追加
   - 完了: フォーム送信後に結果ページで総資産推移/投資元本/資産比率/表を表示

2) フォーム → API 連携の実装
   - 変更: `src/pages/FormPage.tsx` に `onSubmit` を実装し `POST /api/simulate` へ入力を送信
   - 受領データを `ResultPage` にナビゲーション/ステート渡し（`navigate('/result', { state })` またはグローバルストア）
   - 完了: フォーム完了→API応答→結果ページ描画が動作

3) ダッシュボード統合の再利用
   - 再利用: `src/components/dashboard/*` を `ResultPage` に集約
   - 変換: APIの年次データをコンポーネント入出力に合わせて整形（例: 現金/NISA/iDeCo/総資産のキー）
   - 完了: サンプルページ相当の可視化をAPIデータで表示

4) 最低限のバリデーションとエラー表示
   - 導入: 軽量バリデーション（数値/必須/範囲）とAPIエラー時のUI（トースト/インライン）
   - 完了: 異常入力と通信失敗時にユーザーが復帰可能

### Phase 1: 型/設計の堅牢化とUX向上
5) 型の共通化とスキーマ定義
   - 追加: `src/types/simulation.ts`（`InputParams`, `YearlyData` 等を定義）
   - 共有: バックエンド側にも同型を複製/共有（モノレポ内共有 or `api/` 直下に型を配置して両側import）
   - 完了: API I/F とフロント間の型齟齬を解消

6) zod による入力/受信バリデーション
   - 追加: `src/schemas/simulation.ts` に zod スキーマ
   - 適用: フロント入力検証＋API受信時の検証
   - 完了: 不正値を早期に検出し、エラーメッセージを一貫化

7) フォームの分割と可読性改善
   - 追加: `src/components/form/*`（セクション単位へ分割）
   - 管理: ロジックは `hooks/useSimulation.ts` や `store` に集約（既存構想に沿う）
   - 完了: `FormPage.tsx` の肥大化を解消し保守性向上

8) 結果ページの導線と再試行性
   - 機能: 結果から設定に戻って再実行、スクロール/セクション内リンク、OGP設定
   - 完了: 主要フローの回遊性が向上

### Phase 2: 計算精度/機能拡張
9) 税/社会保険料の精度向上
   - 方式: 所得区分ごとの控除/税率、住民税、社会保険（概算上限/下限）を段階的に精緻化
   - 完了: ドキュメント化した前提とテストが整備

10) 投資シナリオ/ストレステストの明確化
   - 既存: `interestScenario`, `stressTest` をUIから制御、計算パスの可視化
   - 完了: 固定/ランダムの差がUI/結果に明確反映

11) 保存/復元（段階導入）
   - Step1: `localStorage` 自動保存&復元
   - Step2: サインイン（Eメール/匿名）、Vercel KV/PostgresやSupabaseでの保存
   - 完了: プランの保存・読み込み・比較の第一歩

### Phase 3: 品質保証と運用
12) テスト整備
   - 単体: 計算ロジック（投資/イベント/退職/年金/取り崩し）のケース網羅（Vitest）
   - UI: コンポーネント/フォームの動作（React Testing Library）
   - E2E: 主要シナリオ（作成→実行→結果）を Playwright で自動化

13) CI/CD とモニタリング
   - GitHub Actions: `npm ci`, lint, typecheck, unit/E2E, `vercel deploy`（PRプレビュー）
   - Sentry: クライアント/関数でのエラー捕捉と通知

## 3. 実装詳細（タスクと手順）

### T0: 結果ページの新設
- 追加: `src/pages/ResultPage.tsx`
- 内容: `SamplePage` での可視化資産をAPIデータに置換し構成（TotalAssetChart, InvestmentPrincipalChart, AssetPieChart, AssetTable などを再利用）
- I/O: `location.state` で `{ yearlyData, input }` を受領、なければフォームに戻す
- 完了条件: 代表的入力で総資産推移に値が描画される

### T1: ルート追加
- 変更: `src/App.tsx` に `<Route path="/result" element={<ResultPage />} />`
- 導線: Top→Form→Result（Top→Sample は残す）

### T2: フォーム送信処理
- 変更: `src/pages/FormPage.tsx`
  - `onSubmit` で入力を `InputParams` に整形 → `fetch('/api/simulate', { method: 'POST', body: JSON.stringify(input) })`
  - 応答 `yearlyData` を `navigate('/result', { state: { yearlyData, input } })` で渡す
  - ローディング/エラー表示を追加

### T3: 型とスキーマの導入
- 追加: `src/types/simulation.ts`（`InputParams`, `YearlyData`）
- 追加: `src/schemas/simulation.ts`（zod）
- 適用: フォーム変換・APIリクエスト・レスポンスの型/スキーマ検証

### T4: フォーム分割
- 追加: `src/components/form/{Family,Income,Expense,Car,Housing,Marriage,Children,Appliances,Care,Retirement,Investments,Settings}Section.tsx`
- 目的: `FormPage.tsx` の責務分解、再利用/テスト容易化

### T5: 可視化のデータ整形
- 変換: `yearlyData` から
  - 総資産推移: `cash (=savings)`, `investment (=investedPrincipal)`, `nisa`, `ideco`, `totalAssets`
  - 円グラフ: 最新年の構成
  - 投資元本推移: `investedPrincipal` の系列

### T6: 最低限のアクセシビリティ
- 入力: `label`/`aria-*`、フォーカス移動、キーボード操作
- グラフ: 代替テキスト、要約テーブル

### T7: テスト（最小）
- 単体: 投資元本計算と取り崩し（境界年の挙動）
- E2E: `Top→Form→Result` の幸福経路1本

## 4. 技術選定メモ
- 型共有: 現状はモノレポ内で `src/types` 参照。将来的に `@/types` エイリアス設定も検討（Viteの`resolve.alias`）。
- 状態管理: まずはページ間引き継ぎを `navigate(...state)` で。複数保存/比較の段で Zustand/Redux を導入。
- 永続化: 初手 `localStorage`。次に Supabase か Vercel Postgres（ランタイム/コスト/運用性で選定）。

## 5. リスクと対応
- 大規模フォームの保守性: 早期分割＋型/スキーマで抑制
- 計算前提の差異: 要件整理書に前提を明示、ユニットテストで固定化
- パフォーマンス: 再レンダー最適化（メモ化/セクション粒度）、グラフのデータ点制御

## 6. 成果の確認（受け入れ）
- Phase 0: 代表入力でフォーム→結果の一連が動作し、グラフ/表/サマリーが表示される
- Phase 1: 主要入力の型/スキーマが整い、フォームは分割・再利用可能、エラーUIが一貫
- Phase 2/3: 精度向上のテストが追加され、CI で自動検証、任意でSentry導入

---
詳細な残課題は `blueprint/unimplemented_features.md` と同期し、本計画に順次取り込みます。

