# FormPage.tsx UI/UX テスト計画書

前提: 本ドキュメントは `src/pages/FormPage.tsx` および関連フロントエンド実装が、要件定義書ならびに `blueprint/form_based_simulation_conditions.md`、`blueprint/simulation_logic_from_form.md` などで定義された仕様を満たしているかを確認するための UI/UX テスト観点と代表テストケースを整理したものである。

テストコードは、原則として以下のレイヤーに配置する。

- コンポーネント単体・フック単体
  - `src/test/components/` 配下（例: `FormPage.test.tsx`）
  - `src/test/hooks/` 配下（例: `useFormState.test.ts`）
- 画面遷移・ブラウザ挙動を含むエンドツーエンド
  - `playwright` 配下（例: `tests/form-page.spec.ts`）

---

## 1. 対象と目的

- 対象
  - 入力フォームページ本体
    - `src/pages/FormPage.tsx`
  - 入力状態管理と自動計算ロジック
    - `src/hooks/useFormState.ts`
  - フォームセクションコンポーネント群
    - `src/components/form/FamilySection.tsx`
    - `src/components/form/IncomeSection.tsx`
    - `src/components/form/ExpenseSection.tsx`
    - `src/components/form/CarLifeEventSection.tsx`
    - `src/components/form/HomeLifeEventSection.tsx`
    - `src/components/form/MarriageLifeEventSection.tsx`
    - `src/components/form/ChildrenLifeEventSection.tsx`
    - `src/components/form/LivingLifeEventSection.tsx`
    - `src/components/form/ParentCareLifeEventSection.tsx`
    - `src/components/form/RetirementLifeEventSection.tsx`
    - `src/components/form/RetirementIncomeSection.tsx`
    - `src/components/form/SavingsSection.tsx`
    - `src/components/form/InvestmentSection.tsx`
    - `src/components/form/SimulationSettingsSection.tsx`
  - ルーティングおよび結果画面への遷移
    - `src/App.tsx`
    - `src/pages/ResultPage.tsx`
- 目的
  - シミュレーションの入力フォームが、想定ユーザーシナリオに対して「迷わず」「誤入力なく」「一定時間内に」入力完了できることを保証する。
  - 入力値に基づくサマリー表示やフローティング情報ボックスなどの UI が、常に最新状態と整合し、ユーザーの判断を支援できているかを検証する。
  - ブラウザバック・離脱・再訪問時に、フォーム状態の保持・復元が適切に行われることを確認し、入力喪失による UX 劣化を防止する。
  - アクセシビリティおよびレスポンシブ対応の観点から、主要デバイス・入力手段（マウス・キーボード）で支障なく利用できることを確認する。
  - `/api/simulate` との連携部分について、API 側の詳細ロジックに依存せずとも、UI として適切なローディング表示・エラーハンドリングが行われることを確認する。

---

## 2. テスト範囲と前提条件

### 2.1 テスト範囲

- マルチステップフォームとしての基本動作
  - `effectiveSections` と `currentSectionIndex` に基づくセクション遷移
  - 「次へ」「戻る」「セクション一覧モーダル」からの移動
  - 進捗バー（プログレスバー）の表示と進捗率計算
- 入力とバリデーション
  - `useFormState` 内の `handleInputChange` ・ `validateSection` を用いた入力制限・必須チェック
  - セクション別エラー表示（エラーメッセージ・エラー状態のスタイル）
  - 無効な状態のまま次のセクションや確認画面へ進めない制御
- 動的な情報表示・自動計算
  - 生活費詳細入力（詳細モード）における合計額 `totalExpenses` の自動計算表示
  - 結婚後生活費・住居費の自動提案ロジック（`planToMarry` と `isLivingCostEdited` などに応じた挙動）
  - フローティング情報ボックス（`renderFloatingBox`）
    - 現在の収入・支出・ローン返済額・投資額・ライフイベント費用などの強調表示
  - 確認画面（`renderConfirmationView`）におけるイベントタイムライン・収支サマリー表示
- 状態保持・復元・遷移制御
  - `localStorage` を用いたフォーム状態キャッシュ（`LIFE_PLAN_FORM_CACHE_KEY`）
  - `showRestoreModal` による復元案内モーダルの表示・動作
  - `window.history.pushState` と `popstate` イベントによるブラウザバック対応
  - 別ページ（結果画面等）からの戻り時に、指定セクションに復帰する挙動（`location.state.sectionIndex`）
- API 呼び出しとエラー処理
  - `handleSimulate` 内での `fetch('/api/simulate')` 実行とローディング状態の反映
  - API 正常応答時の `/result` への遷移と `navigate` 引数（`yearlyData`, `summary`, `percentileData`, `inputParams`, `rawFormData`）の整合
  - API エラー・ネットワークエラー時におけるエラーメッセージ表示（`result` ステートへの格納内容）
- アクセシビリティと表示品質
  - ラベル・説明文と入力要素の関連付け、見出し階層、ランドマーク
  - キーボード操作のみで全ステップを完了できるか
  - モーダル表示時のフォーカス制御・スクロールロック
  - 主要画面幅（スマートフォン・タブレット・PC）におけるレイアウト崩れの有無

### 2.2 前提条件・環境

- Node.js / Vite / TypeScript のバージョンは `package.json`・`tsconfig*.json` に従う。
- 単体・コンポーネントテスト
  - `Vitest` ＋ `React Testing Library` による実装を前提とする。
  - DOM 実行環境として `jsdom` を利用する。
- E2E テスト
  - `Playwright` によるブラウザ自動操作を前提とする。
  - `/api/simulate` へのリクエストは、E2E テストではモックサーバーまたは Playwright の `route` 機能でスタブ化し、API 側ロジックの変更に影響されないようにする。
- ブラウザ
  - 開発時検証対象: Chromium 系（Chrome）, WebKit（Safari 相当）, Firefox
  - スマートフォン相当のビューポートについては、Playwright のデバイス設定を用いて確認する。

---

## 3. テスト観点（高レベル）

### 3.1 入力フォームの基本操作性

- マルチステップ UI としての自然な流れになっているか。
- セクションタイトル・説明文が、ユーザーにとって理解しやすい日本語になっているか。
- 各入力項目の単位（万円・年齢・年数など）が明示されているか。
- エラー発生時に、どの項目が原因か即座に分かる表示になっているか。

### 3.2 バリデーションとエラーメッセージ

- 必須項目が未入力のとき、適切なエラーメッセージが表示されるか。
- 形式異常（数値項目への文字入力など）のとき、即時にエラーが表示されるか、またはセクション確定時に検知されるか。
- 数値の範囲外（極端に大きい・負の値など）が入力された場合に、警告や入力制限が適切に機能するか。
- エラーが解消されたとき、エラー表示が速やかに消えるか。

### 3.3 ナビゲーションとブラウザ履歴

- 「次へ」「戻る」ボタンの活性・非活性の条件が仕様通りであるか。
- `visitedSections` を用いたセクション一覧モーダルからのジャンプが、想定通りのセクションへ移動するか。
- ブラウザの戻る・進むボタンを用いても、セクションが壊れた状態にならず、`popstate` ハンドリングにより復元されるか。
- 結果画面から「入力へ戻る」操作を行ったとき、元のセクションに戻るか。

### 3.4 状態保持・復元

- 入力途中でブラウザタブを閉じる、またはリロードした場合に、`beforeunload` でフォーム状態が `localStorage` に保存されるか。
- 再訪問時に `showRestoreModal` が表示され、「復元する」「新しく始める」の選択肢が仕様通りに動作するか。
- 復元した状態で入力を続行しても、バリデーションや自動計算が正常に機能するか。
- 過去のキャッシュが古くなった場合（スキーマ変更など）に、必要に応じて安全に破棄される設計になっているか（テストでは、少なくとも異常終了しないことを確認する）。

### 3.5 情報表示・フィードバック

- 詳細生活費入力時に、`totalExpenses` が想定通りの値を示すか。
- フローティング情報ボックス（生活費総額・年間手取り総額・ローン返済額など）が、該当セクションを開いたときのみ表示されるか。
- スクロールやソフトキーボード表示時に、`floating-header` の位置がずれず、視認性が確保されるか。
- 確認画面におけるイベントタイムラインが、入力したライフイベント（結婚・住宅購入・介護・退職・年金開始など）と整合しているか。
- エラー時に `result` に格納されたメッセージが、ユーザーにとって理解しやすい文面で表示されるか。

### 3.6 アクセシビリティ

- 主要なフォーム要素にラベル・説明が適切に関連付けられているか。
- エラー発生時にスクリーンリーダーでエラーを認識できるか（必要であれば `aria-live` 等の利用を検討）。
- モーダル表示時にフォーカスがモーダル内にトラップされ、閉じると元のフォーカス位置に戻るか。
- キーボード操作のみで、全項目の入力・セクション遷移・確認画面まで到達できるか。

### 3.7 パフォーマンス・レスポンシブ

- 通常想定される入力量で、操作が著しく重くならないか。
- スマートフォン幅で各セクションが読みやすく、ボタンが画面外に隠れないか。
- 縦長画面でのスクロール位置が極端に飛ばず、次に入力すべき項目が常に画面内にあるか。

---

## 4. 代表テストケース

以下では、特に重要度が高いと想定される代表テストケースを列挙する。実装時には、これらを起点として細かなバリエーション（境界値・異常系など）を追加していく。

### 4.1 マルチステップフォームの基本動作

- **TC-FORM-001: 基本シナリオでのセクション遷移**
  - 種別: E2E（Playwright）
  - 条件:
    - 独身で子どもなし、賃貸住宅、投資なしの最小構成シナリオ。
  - 期待される結果:
    - 各セクションで必須項目を入力すると、「次へ」ボタンが活性化し、最終セクションまで連続して遷移できる。
    - プログレスバーが、セクション数に応じて均等に進む。
    - 最終セクションで「確認へ」ボタンを押すと、確認画面に遷移する。

- **TC-FORM-002: バリデーションエラーによる遷移ブロック**
  - 種別: コンポーネントテスト（FormPage ＋ useFormState）
  - 条件:
    - 家族構成・年齢などの必須入力を空のまま「次へ」をクリック。
  - 期待される結果:
    - 対象項目にエラーメッセージが表示される。
    - エラーが解消されるまで次のセクションに進めない。

- **TC-FORM-003: セクション一覧モーダルからのジャンプ**
  - 種別: E2E（Playwright）
  - 条件:
    - いくつかのセクションを順に通過してから、「戻る」ボタンでセクション一覧モーダルを開く。
  - 期待される結果:
    - `visitedSections` に登録されたセクションのみが選択肢として表示される。
    - 任意のセクションを選ぶと、そのセクションのフォーム内容が表示される。

### 4.2 状態保持・復元

- **TC-FORM-010: 入力途中でのタブクローズと復元**
  - 種別: E2E（Playwright）
  - 条件:
    - いくつかのセクションに入力を行った状態で、ブラウザタブを閉じる（またはリロード）。
    - 再度 `/form` にアクセスする。
  - 期待される結果:
    - 初回ロード時に `showRestoreModal` が表示され、「前回の入力を復元しますか？」（実際のメッセージ文言に合わせる）と問われる。
    - 「復元する」を選択すると、入力済みの値がフォームに復元される。
    - 「新しく始める」を選択すると、初期状態のフォームが表示される。

- **TC-FORM-011: 結果画面から入力フォームへの戻り**
  - 種別: E2E（Playwright）
  - 条件:
    - `handleSimulate` によって正常なシミュレーションが完了し、結果画面へ遷移する。
    - 結果画面上の「入力に戻る」リンクまたはボタンをクリックする。
  - 期待される結果:
    - `location.state.sectionIndex` が指定されている場合、そのセクションに復帰する。
    - バリデーション状態や計算結果が破綻していない。

### 4.3 動的計算と情報表示

- **TC-FORM-020: 詳細生活費入力と合計額の表示**
  - 種別: フック単体テスト（useFormState）／コンポーネントテスト
  - 条件:
    - `expenseMethod` を「詳細」に設定し、固定費・変動費の項目に値を入力する。
  - 期待される結果:
    - `totalExpenses` が各項目の合計と一致する。
    - フローティングボックス「生活費総額」に表示される金額が `totalExpenses * 12` 相当の年額と整合する。

- **TC-FORM-021: 結婚後生活費・住居費の自動提案**
  - 種別: フック単体テスト（useFormState）
  - 条件:
    - `planToMarry` を「する」に設定。
    - 独身時の生活費・住居費を入力し、`isLivingCostEdited`・`isHousingCostEdited` が偽の状態。
  - 期待される結果:
    - 一定の係数（`POST_MARRIAGE_COST_INCREASE_RATE`）に基づいて、`livingCostAfterMarriage` と `housingCostAfterMarriage` が自動計算・設定される。
    - ユーザーが手動で上書きし `isLivingCostEdited` 等が真になった後は、自動更新されない。

- **TC-FORM-022: 確認画面のイベントタイムライン**
  - 種別: コンポーネントテスト（FormPage）
  - 条件:
    - 結婚・住宅購入・親の介護・退職・年金開始など、複数のライフイベントを設定して確認画面へ遷移。
  - 期待される結果:
    - それぞれのイベント年齢に応じたイベントカードが表示される。
    - 各イベントのタイトルと金額表示が入力内容と整合している。

### 4.4 API 連携とエラーハンドリング

- **TC-FORM-030: シミュレーション正常完了時の遷移**
  - 種別: コンポーネントテスト（モック fetch）／E2E
  - 条件:
    - `fetch('/api/simulate')` が `200` と `yearlyData` を含むレスポンスを返すようにモックする。
  - 期待される結果:
    - 「シミュレーションを実行」ボタン押下時にローディング状態が表示される。
    - 正常応答後に `navigate('/result', { state: ... })` が呼び出され、結果画面に遷移する。
    - ローディング状態が解除される。

- **TC-FORM-031: API エラー時のエラーメッセージ表示**
  - 種別: コンポーネントテスト（モック fetch）／E2E
  - 条件:
    - `fetch` が `500` 相当のステータス、またはネットワークエラーを返すようにモックする。
  - 期待される結果:
    - ローディング状態が解除される。
    - `result` に `{ error: メッセージ }` が設定され、画面下部の JSON 表示欄にエラー内容が表示される。
    - ユーザーが再度シミュレーション実行を試みることができる。

### 4.5 アクセシビリティ・キーボード操作

- **TC-FORM-040: キーボードのみでのフォーム完了**
  - 種別: E2E（Playwright）
  - 条件:
    - マウス操作を行わずに、Tab キーと Enter／Space キーのみで操作する。
  - 期待される結果:
    - 入力順が自然であり、重要な項目を飛ばさない。
    - モーダル表示時にフォーカスがモーダル内に閉じ込められ、閉じると元の位置に戻る。
    - 最終的に確認画面までたどり着ける。

- **TC-FORM-041: アクセシビリティ自動検査の実施**
  - 種別: コンポーネントテスト（`jest-axe` 等）／E2E
  - 条件:
    - 代表的なセクションと確認画面に対して、自動アクセシビリティ検査を実行する。
  - 期待される結果:
    - 重大度の高いアクセシビリティ違反（コントラスト不足、ラベル欠如など）が検出されない。

---

## 5. 完了条件

- 上記代表テストケースが実装され、CI 上で自動実行されている。
- 主要ユーザーシナリオ（独身・既婚、子どもあり・なし、住宅購入あり・なし）が、UI 上の操作だけで問題なく完了できることが確認されている。
- アクセシビリティ検査で重大な問題がないことが確認されている。
- 新規の UI 変更やリファクタリング（`FormPage.tsx`・`useFormState.ts`・フォームセクション分割等）の際に、既存テストにより大きな UX 劣化が検知可能である状態になっている。

---

## 6. 関連ドキュメント

- API 側のテスト仕様
  - `blueprint/simulation-api/01_test_spec.md`
- シミュレーションロジック仕様
  - `blueprint/simulation_logic_from_form.md`
  - `blueprint/simulation_logic_fixes.md`
- 入力フォーム仕様
  - `blueprint/form_based_simulation_conditions.md`
- 結果画面の可視化仕様
  - `blueprint/result_page_visualization.md`
- 全体テスト計画
  - `tasklist/004-test-plan.md`

