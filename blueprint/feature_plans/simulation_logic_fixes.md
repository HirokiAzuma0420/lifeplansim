# シミュレーションロジックの修正履歴

このドキュメントは、過去に特定されたシミュレーションロジックの問題と、その修正内容を記録するものです。

## 1. 投資リターン（ストレステスト）の計算ロジック

### 問題点 (過去の課題)

ストレステスト選択時、各投資商品の年間リターンを乱数で生成していたが、シミュレーション期間全体で見たときに、ユーザーが設定した「平均想定リターン」に収束することが保証されていなかった。
各年のリターンが独立した乱数で決まるため、結果的に平均リターンが想定よりも大幅に高くなったり低くなったりする可能性があった。

### 解決策 (現在の実装)

上記の問題は、`api/simulate/index.ts` の `generateReturnSeries` 関数にて解決済みです。
現在の実装では、ユーザーが設定した平均リターンを尊重しつつ、より現実的なリスクを反映する以下のロジックが採用されています。

1.  **リターン系列の生成と暴落イベントの挿入**:
    - まず、目標とする算術平均リターンとボラティリティに基づき、正規分布に従うリターン系列をシミュレーション期間分、生成します。
    - 次に、シミュレーション期間中のランダムな年に、-30%から-60%の**暴落イベント**を複数回、強制的に挿入します。

2.  **平均リターンへの事後補正**:
    - 暴落イベントを含むリターン系列全体の合計値を計算します。
    - 目標とする「平均リターン × 年数」の合計値と、実際の合計値との間に生じた差額を算出します。
    - この差額を、暴落が発生しなかった全ての年に均等に配分（加算または減算）して補正します。

このアプローチにより、ランダムな暴落を含む現実的なボラティリティを再現しつつ、シミュレーション期間全体を通した平均リターンがユーザーの設定値に一致することが保証されます。
