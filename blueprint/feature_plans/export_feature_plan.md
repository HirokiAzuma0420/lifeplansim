# シミュレーション結果の保存機能拡張計画書

## 1. 目的

現在のシミュレーション結果保存機能はJSON形式での出力のみであり、専門知識のないユーザーにとっては内容の確認や再利用が難しい。
そこで、より一般的で分かりやすい形式であるPDFおよびExcel形式での出力機能を追加し、ユーザー体験を向上させる。

- **PDFレポート**: 視覚的に分かりやすいレポート形式で、結果の概要を把握したり、他者と共有したりしやすくする。
- **Excelデータ**: ユーザー自身がデータを加工・分析できるよう、詳細な年次データを表形式で提供する。

## 2. 対象機能

`ResultPage.tsx` に実装されている「結果を保存」機能。

## 3. UI/UXの変更案

現在の「結果を保存」ボタンをドロップダウンメニューに変更し、ユーザーが出力形式を選択できるようにする。

```
[結果を保存 ▼]
  ├─ レポートを保存 (PDF)
  ├─ 詳細データを保存 (Excel)
  └─ 生データを保存 (JSON)  <-- (既存機能)
```

- **ボタン**: `ResultPage.tsx` の既存ボタンをドロップダウンコンポーネントに置き換える。
- **メニュー項目**:
  - **レポートを保存 (PDF)**: PDF出力機能を呼び出す。
  - **詳細データを保存 (Excel)**: Excel出力機能を呼び出す。
  - **生データを保存 (JSON)**: 既存のJSON出力機能を維持し、開発者や詳細な分析をしたい上級者向けに残す。

## 4. 機能詳細

### 4.1. PDFレポート出力機能

**概要**:
結果ページの主要なグラフやサマリー情報を1つのPDFファイルとして出力する。

**PDFに含める内容**:
- **タイトル**: 「シミュレーション結果レポート」
- **サマリー**:
  - 「サマリーカード」に表示されている主要指標（最終資産、ピーク資産、プラン破綻確率など）。
  - 「入力条件サマリー」の内容（現在年齢、退職予定年齢など）。
- **主要グラフ**:
  - 総資産推移グラフ (`TotalAssetChart`)
  - 投資元本と評価額グラフ (`InvestmentPrincipalChart`)
  - 資産構成パイチャート (`AssetPieChart`)
- **ライフプラン**:
  - ライフプラン・タイムライン (`LifePlanTimeline`)

**実装方針**:
- `jspdf` と `html2canvas` ライブラリを導入する。
- `html2canvas` を使用して、`ResultPage.tsx` 内の対象コンポーネントを画像に変換する。
- `jspdf` を使用して、キャプチャした画像やテキスト情報をPDFドキュメントに配置し、生成する。
- PDF出力用に、印刷に適したレイアウトのコンポーネントを別途作成することも検討する。

### 4.2. Excelデータ出力機能

**概要**:
シミュレーション結果の年次データをExcelファイル（`.xlsx`）として出力する。JSONの `debug` 情報は除外する。
JSONのデータ構造に準拠し、可能な限り詳細な情報を保持する。

**Excelのシート構成案**:
1.  **年次データサマリー (YearlySummary)**:
    - JSONのトップレベルのキーを日本語の列名に変換して展開する。
    - ネストされたオブジェクト（例: `incomeDetail`）は、「収入詳細_本人」のように分かりやすい日本語の列名に変換する。
    - **列名の例**:
      - `年`, `年齢`
      - `年間収入`, `年間支出`, `年間収支`, `年間投資額`
      - `総資産`, `投資元本`, `現金預金`
      - `収入詳細_本人`, `収入詳細_配偶者`, `収入詳細_資産運用`, ...
      - `支出詳細_生活費`, `支出詳細_住居費`, `支出詳細_自動車`, ...
      - `NISA_元本`, `NISA_評価額`
      - `iDeCo_元本`, `iDeCo_評価額`
      - `課税口座_元本`, `課税口座_評価額`
      - `資産配分_現金`, `資産配分_課税口座`, `資産配分_NISA`, `資産配分_iDeCo`

2.  **商品別資産詳細 (ProductsDetail)**:
    - `products` オブジェクトの詳細を年ごとに展開する。
    - **列名の例**:
      - `年`, `年齢`
      - `商品キー` (例: "stocks-0", "trust-1")
      - `元本`
      - `評価額`

3.  **入力パラメータ (InputParams)**:
    - シミュレーションに使用した入力パラメータ (`inputParams`) を保存するシート。
    - キーを日本語に変換し、どのような条件で実行された結果なのかを明確にする。

**実装方針**:
- `xlsx` や `exceljs` などのExcelファイル生成ライブラリを導入する。
- `yearlyData` (シミュレーションAPIからの生データ) を加工し、`debug` プロパティを除外する。
- JSONのキーと日本語の列名を対応付けるマッピングオブジェクトを定義する。
- 加工したデータを元に、ライブラリを使用して複数のシートを持つExcelファイルを生成する。
- ネストされたオブジェクト（例: `incomeDetail`）は、「収入詳細_本人」のような分かりやすい日本語のヘッダー名に変換してフラットなテーブル構造にする。

## 5. 開発タスク

1.  UIコンポーネントの作成: ドロップダウンメニューの実装。
2.  PDF出力機能の実装:
    - 関連ライブラリ (`jspdf`, `html2canvas`) の導入。
    - `ResultPage.tsx` の要素をキャプチャし、PDFを生成するロジックの作成。
3.  Excel出力機能の実装:
    - 関連ライブラリ (`xlsx` ) の導入。
    - `yearlyData` を整形し、Excelファイルを生成するロジックの作成。
4.  `ResultPage.tsx` に新機能の呼び出し処理を統合。
5.  単体テストおよび結合テストの実施。