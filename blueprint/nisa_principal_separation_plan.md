# NISA口座の元本と評価額の分離対応計画書

## 1. 背景

現状の投資セクションにおけるNISA口座の入力は、評価額を含んだ総額を単一のフィールドで入力する形式となっている。
しかし、NISAの非課税投資枠は買付額（元本）を基準に管理されるため、シミュレーションの精度、特に初年度の投資額計算や将来の非課税枠の計算において、元本と評価損益を分離して扱う必要がある。
この乖離を解消し、より正確なライフプランシミュレーションを提供するために、入力UIと内部ロジックの改修を行う。

## 2. 目的

- ユーザーがNISA口座の「評価総額」と「騰落率」を個別に入力できるようにする。
- 入力された値から投資元本を正確に算出し、シミュレーションの初期データとして利用する。
- シミュレーション結果の表示において、元本と評価額を区別して表示できるようにし、ユーザーの資産状況の透明性を高める。

## 3. 実装計画

### ステップ1：フォームUIの変更 (`InvestmentSection.tsx`)

投資セクションのNISA入力フォームを以下のように変更する。

1.  **評価総額入力**:
    - 既存の入力フィールドを活用し、ラベルを「評価総額」など、総額であることが明確にわかるように調整する。
2.  **騰落率入力**:
    - 新たに「騰落率」の入力エリアを設ける。
    - 騰落率のプラス/マイナスを直感的に選択できるよう、ラジオボタンまたはトグルスイッチ（`+` / `-`）を設置する。
    - 数値入力フィールドを設け、小数点以下の入力も可能とする。
3.  **State管理の更新 (`useFormState.ts`)**:
    - `formState`に騰落率と符号を保持するための新しいstateを追加する。
    - 関連する型定義 (`form-types.ts`) も更新する。

### ステップ2：データ変換ロジックの追加 (`api-adapter.ts`)

フォームから送信されたデータをシミュレーションAPIの入力形式に変換する`api-adapter.ts`に、元本を計算するロジックを追加する。

1.  **元本算出ロジック**:
    - 以下の計算式を用いて、評価総額と騰落率から元本を算出する。
      ```
      元本 = 評価総額 / (1 + (騰落率 / 100))
      ```
    - 騰落率がマイナスの場合は、符号を適切に処理する。
2.  **APIパラメータへの反映**:
    - 算出した元本を、シミュレーションのインプットパラメータ（`SimulationInput`）における初年度のNISA積立額（`investment.nisa.initialPrincipal`のような新しいプロパティ）として設定する。

### ステップ3：シミュレーションロジックへの統合

- 算出された元本ベースで、初年度のNISA積立額が計算されるように、シミュレーション本体のロジックを調整する。
- 資産推移の計算において、初年度の資産は「元本」と「評価損益」に分解された状態で開始されるようにする。

### ステップ4：結果表示コンポーネントの修正 (`AssetTable.tsx`等)

シミュレーション結果を表示するダッシュボードコンポーネントを修正し、元本と評価額を区別して表示できるようにする。

1.  **資産内訳テーブル (`AssetTable.tsx`)**:
    - テーブルのカラムに「元本」「評価損益」「評価総額」などを設け、NISA資産の内訳がわかるように表示を修正する。
2.  **各種チャートコンポーネント**:
    - `TotalAssetChart`や`AssetPieChart`などで、NISA資産の表示粒度について、元本ベースか評価額ベースか、どちらで表示するのがユーザーにとって有益かを検討し、必要に応じて修正する。

## 4. 影響範囲

- `src/components/form/InvestmentSection.tsx`
- `src/hooks/useFormState.ts`
- `src/types/form-types.ts`
- `src/utils/api-adapter.ts`
- `src/components/dashboard/AssetTable.tsx`
- `src/components/dashboard/TotalAssetChart.tsx`
- `src/components/dashboard/AssetPieChart.tsx`
- `api/simulate/index.ts` (シミュレーションロジック)
- `src/types/simulation-types.ts`

## 5. テスト計画

1.  **単体テスト**:
    - `api-adapter.ts`に追加した元本算出ロジックについて、騰落率がプラス、マイナス、ゼロの場合のテストケースを作成し、計算が正確であることを確認する。
2.  **コンポーネントテスト**:
    - `InvestmentSection.tsx`で、騰落率の入力がstateに正しく反映されることを確認する。
    - `AssetTable.tsx`で、元本と評価額が分離して表示されることを確認する。
3.  **E2Eテスト**:
    - NISA口座情報を入力（例：評価額120万円、騰落率+20%）し、シミュレーションを実行する。
    - 結果画面の資産テーブルで、元本が100万円、評価損益が+20万円と表示されることを確認する。
    - 初年度の資産推移が、元本100万円を基準に計算されていることを確認する。
