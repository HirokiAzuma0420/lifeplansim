# ライフプラン資産シミュレーションAPIロジックをステップバイステップで実装するための精密指示

あなたはローカルLLM実行役です。  
以下の指示を必ず**順番通り・厳密に**実行してください。  
どのステップも省略せず、必ずテスト→進捗確認→次の実装へと進めてください。

---

## 【前提】
- フロントエンドから`/api/simulate`にフォーム入力データ（inputParams）がPOSTされてきます。
- APIはindex.ts（TypeScript）で書かれています。
- 計算結果を{ result: ... }の形でJSON返却してください。

---

## 【実装ステップ】

### 【Step 1】APIの雛形と最小限の年次ループ構築

1. APIの`handler`関数でinputParams（POSTデータ）を受け取れるようにしなさい。
2. inputParamsから「初期年齢」「シミュレーション終了年齢」「現在の貯蓄額」「本業年収」などのパラメータを取得せよ。
3. 年齢ごとのループ（for文など）を用意し、各年の収入・支出・資産残高を配列`years`に記録せよ。
4. 収入は「本人本業（昇給率あり）」だけ、支出は「生活費」だけでよい。
5. 各年の「資産残高＝前年の残高＋収入−支出」を計算し、years配列に{year, age, income, expense, assets}を格納せよ。
6. 計算結果を{ result: { years, finalAssets } }で返却せよ。

### 【Step 2】収入ロジックの拡張

1. 収入項目に「本人副業」「配偶者本業（昇給率あり）」「配偶者副業」を追加せよ。
2. 昇給率がある項目は毎年所定の昇給率で金額を増やせ。
3. 副業は昇給率なしで固定額。
4. 各年の総収入を計算し、years配列に記録せよ。

### 【Step 3】支出ロジックの拡張

1. 生活費以外に「自動車（頭金・購入頻度・ローン設定あり）」と「住宅（頭金・ローン設定あり）」を追加せよ。
2. ローン支出（自動車・住宅）は頭金、返済年数、金利をinputParamsから取得し、年ごとの支払額を正確に計算すること。
3. 自動車は購入頻度ごとに買い替え支出も発生させる。
4. 各支出を年次ごとに合算し、years配列に記録せよ。

### 【Step 4】ライフイベント・可変支出の導入

1. 子供支出（出産タイミング・養育費パターン）、生活支出（家電買い替えタイミングによる支出）、介護支出（介護期間設定あり）を追加せよ。
2. それぞれ、inputParamsでイベント開始年・発生年数・費用パターンを読み取り、該当年に正しい額が加算されるようにせよ。
3. 老後支出は「年金受給開始年齢以降、生活費−年金額」で不足分を支出として記録すること。

### 【Step 5】貯蓄と投資商品の計算

1. 年ごとの資産推移計算に「毎年の貯蓄額」も反映させる（初期値は現総額、以後はその年ごとに加算）。
2. 投資商品（株式・投資信託・債権・iDeCo・仮想通貨・その他）は、それぞれ月次・スポット購入額と利回りを使い、年ごとに複利計算するロジックを作れ。
3. 投資合計も資産残高に正しく加算すること。

### 【Step 6】ストレステスト・シナリオ分岐の実装

1. inputParamsの設定によって「投資ストレステストオプション」がONなら、各アセットのリスク幅・変動率も考慮したランダム利回りで年ごとに投資額を計算せよ。
2. シミュレーションパターン（シナリオ）を複数回走らせて統計値（最悪・平均・最高）を算出できるようにせよ。

### 【Step 7】出力設計とエラー・バリデーション強化

1. 各年ごとのデータをyears配列で返すだけでなく、警告（資産がマイナスになる年など）やアラートもレスポンスに含めること。
2. 入力値のバリデーション・エラーハンドリングを強化し、不正データにはHTTP400でエラーメッセージを返すこと。

### 【Step 8】フロントエンド表示対応

1. フロントエンドで必要な出力（年ごとの資産推移、グラフ用データ、警告メッセージ等）を網羅的に返却し、フロントの設計と合わせて仕様調整すること。

---

## 【進め方】

- 各Stepが完了したら必ずテストを行い、正しい値が出ているか、想定通りの年次推移や出力になっているかを確認せよ。
- 次のStepに進む前に、現時点でのコード・ロジック・出力例を記録せよ。
- 必ずこの順序で段階的に実装・テストを進め、仕様に不明点があればユーザーに質問を返すこと。

---

この指示内容を厳密に順を追って実行し、各ステップごとに進捗を報告せよ。
